<div id="storyViewer">
  <div id="storyContent">
    <div id="storyProgressBar">
    </div>
  </div>
  <img src="" id="fakeContentToPreloadImages" />
</div>

<script type="text/javascript">
  var storiesToShow = null;
  var timeOutForPhotos = 4.0;
  var storyProgressSpacing = 5;
  var progressPadding = 2;
  var progressBars = null;

  function showStories() {
    var url = "https://instapipe.herokuapp.com/stories.json";
    // url = "http://127.0.0.1:4567/stories.json"

    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
      if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
        var content = JSON.parse(xmlHttp.responseText)
        storiesToShow = []
        progressBars = []

        document.getElementById("storyViewer").style.display = "block"

        for (let storyIndex in content) {
          let currentStory = content[storyIndex]
          if (!currentStory["is_video"]) {
            storiesToShow.push(currentStory)
          }
        }

        for (let currentStoryIndex in storiesToShow) {
          let currentStory = storiesToShow[currentStoryIndex]

          // Append the progress items
          var progressBarBackground = document.createElement("div")
          progressBarBackground.className = "storyProgressBarItemBg"
          progressBarBackground.style.width = "calc(" + (1.0 / storiesToShow.length) * 100 + "%" + " - " + progressPadding * 2 + "px)"
          progressBarBackground.style.marginRight = progressPadding + "px"
          progressBarBackground.style.marginLeft = progressPadding + "px"
          document.getElementById("storyProgressBar").appendChild(progressBarBackground)

          var progressBarForeground = document.createElement("div")
          progressBarForeground.style.width = "0%"
          progressBarForeground.className = "storyProgressBarItemFg"
          progressBarBackground.appendChild(progressBarForeground)

          progressBars.push(progressBarForeground)
        }

        showNextStory(0)
      }
    }
    xmlHttp.open("GET", url, true); // true = asynchronous 
    xmlHttp.send(null);
  }

  function showNextStory(currentIndex) {
    currentStory = storiesToShow[currentIndex]

    // Show image
    document.getElementById("storyContent").style.backgroundImage = "url('" + currentStory["signed_url"] + "')"

    // animate progress bar
    // via https://www.w3schools.com/js/js_htmldom_animate.asp
    progressBarContent = progressBars[currentIndex]
    var startTime = new Date();
    var animationInterval = setInterval(frame, 5);
    function frame() {
      let pos = (new Date().getTime() - startTime.getTime()) / 1000;
      pos = pos * 100.0 / timeOutForPhotos
      progressBarContent.style.width = pos + '%'; 
    }

    // Trigger the next one
    if (currentIndex < storiesToShow.length - 1) 
    {
      setTimeout(function() {
        // Poor person's pre-loading of images, with a slight delay
        document.getElementById("fakeContentToPreloadImages").src = storiesToShow[currentIndex + 1]["signed_url"]
      }, timeOutForPhotos / 3.0 * 1000)

      setTimeout(function() {
        clearInterval(animationInterval); // stop animation, as we reached 100%
        showNextStory(currentIndex + 1);
      }, timeOutForPhotos * 1000)
    } 
    else 
    {
      document.getElementById("storyViewer").style.display = "none"
    }
  }

  // showStories()
</script>

